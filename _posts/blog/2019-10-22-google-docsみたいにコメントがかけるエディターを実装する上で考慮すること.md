---
layout: blog
title: Google Docsみたいにコメントがかけるエディターを実装する上で考慮すること
date: 2019-10-22T08:39:34.983Z
---
# 要件

- 行全体に対してコメントができること
- 行の一部分に対してもコメントができること
- コラボラティブエディタ（複数人で同期しながら編集する）は想定していない

# 前提

エディタのライブラリは以下の機能を提供するものとする。

- 各行はユニークなIDを持つ
- 選択した文字列に対してマーカーを設定することができる。例えばthis is a lineという文があったとすれば、"a lie" → "marker1"みたいな形でマークすることができる。もし仮に複数箇所が選択され、選択箇所に重複している部分がある。例えば"is a"と"a line"にそれぞれmarker1とmarker2がつけられるとすると、"is " → "marker1", "a" → "marker1", "marker2", " line"→"marker2"みたいな表現になる。マーカー名もユニークとする。

# 実装方法

## 新規登録時

- 行IDをキーとするdictionaryとマーカーIDをキーとするdictionaryをそれぞれ作る。コメントIDを生成する。行に対してコメントする際は、コメントオブジェクトを作り、生成したコメントIDを割り当てて、行ディクショナリーは行ID→ [生成したID]のように変更される。マーカーに対するコメントも同様
- サーバーは受け取ったデータを元にグローバルにユニークなマーカーIDや行IDを生成した上でコメントを生成し紐づける

## 編集時

- サーバーからデータを取得し、Slate.jsの内部状態と補助状態 (コメントなど)を生成する。

## DBへの保存方法

1. Slateの内部情報であるJSONをstringifyしてそのまま保存
    - Pro: 一番シンプル。クライアントとサーバー間でのフォーマットが共通化できる
    - Con: 文章全体が一レコードになるので、レコードを複数人でいじる時にロックを全体にかけてしまう
2. Slateの内部情報を行ごとに分割して保存
    - Con: 文の順番を何らかの形で保存しないといけないし、文章を構築しないといけない→ 行IDの配列をserializeすることで解決。順番が変わったりすることは編集・削除によって起こるが、順番が変わる操作ができるのは投稿したユーザーだけなので、パフォーマンス的にそんなに問題ない。
    - Pro: ロックの範囲が文ごと
3. Slateの内部状態に依存しない独自の形式でDBに保存
    - Con: マーカーの紐付けを考えるとマーカーをコンテンツに埋め込むSlateの表現に従った方が良さそう。

## 考慮すべき点

選択箇所が同じであってもマーカーを複数作成することを可能にしたくはないが、現状ではマーカーを複数作れちゃう(GUIで無効にできてもAPIが叩けちゃう)。それはまぁしょうがないからよしとする。
